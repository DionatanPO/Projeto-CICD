name: Flutter CI/CD

on:
  push:
    branches:
      - main
      - dev

# Evita que m√∫ltiplos deploys rodem ao mesmo tempo
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  static_analysis_and_tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true # Ativa o cache para acelerar o processo

      - name: 'Flutter Doctor'
        run: flutter doctor -v

      - name: 'Get Dependencies'
        run: flutter pub get

      - name: 'Analyze Code'
        run: flutter analyze

      - name: 'Run Tests'
        run: flutter test

  build_web:
    needs: static_analysis_and_tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: 'Enable Web'
        run: flutter config --enable-web

      - name: 'Get Dependencies'
        run: flutter pub get

      - name: 'Build Web'
        run: flutter build web --release

      - name: 'Upload Web Build Artifact'
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web

  deploy:
    needs: build_web
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Download Web Build Artifact'
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: build/web

      - name: 'Deploy to Hostinger via SSH'
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rlgoDzvc -i --delete"
          SOURCE: "build/web/"
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USER }}
          # Se for main, usa o REMOTE_PATH direto. Se for dev, adiciona /dev ao final.
          TARGET: ${{ github.ref == 'refs/heads/main' && secrets.REMOTE_PATH || format('{0}/dev', secrets.REMOTE_PATH) }}
          EXCLUDE: "/dist/, /node_modules/"
